<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, remove, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    // Конфиг Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDpPOgY_Jc8QjUq7MSa4rPH26YPXS716VI",
        authDomain: "hk-ai-bf133.firebaseapp.com",
        projectId: "hk-ai-bf133",
        databaseURL: "https://hk-ai-bf133-default-rtdb.europe-west1.firebasedatabase.app/",
        appId: "1:1009853924666:web:fa4e356cf060d747f8bc03"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const messagesRef = ref(db, 'chat_messages');

    // Настройки Gemini напрямую через Fetch (так надежнее для Mini App)
    const GEMINI_API_KEY = "AIzaSyDQfDlE0SlKK8iDXWz_nr-nTF7IC6LeilM";
    const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;

    const container = document.getElementById('chat-container');
    const input = document.getElementById('user-input');
    const typing = document.getElementById('typing');

    let waitingForConfirm = false;

    async function sendMessage() {
        const text = input.value.trim();
        if (!text) return;

        if (text.toLowerCase() === "очисти чат") {
            addMessage("ВЫ ТОЧНО ХОТИТЕ УДАЛИТЬ ИСТОРИЮ?", "ai");
            waitingForConfirm = true;
            input.value = "";
            return;
        }

        if (waitingForConfirm) {
            if (text.toLowerCase() === "да") {
                await remove(messagesRef);
                container.innerHTML = "";
                addMessage("ИСТОРИЯ ОЧИЩЕНА.", "ai");
            } else {
                addMessage("ОТМЕНЕНО.", "ai");
            }
            waitingForConfirm = false;
            input.value = "";
            return;
        }

        // Сохраняем в Firebase
        await push(messagesRef, { text, sender: "user", timestamp: Date.now() });
        input.value = "";
        typing.style.display = "block";

        try {
            // Прямой запрос к Google API без лишних библиотек
            const response = await fetch(GEMINI_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `Ты — HK AI. Отвечай кратко и капсом. Запрос: ${text}` }] }]
                })
            });

            const data = await response.json();
            
            if (data.candidates && data.candidates[0].content.parts[0].text) {
                const aiText = data.candidates[0].content.parts[0].text.toUpperCase();
                await push(messagesRef, { text: aiText, sender: "ai", timestamp: Date.now() });
            } else {
                throw new Error(JSON.stringify(data)); // Бросаем ошибку если API ответил что-то не то
            }

        } catch (e) {
            console.error("DEBUG:", e);
            // Выводим часть ошибки на экран для диагностики
            addMessage("ОШИБКА ЯДРА: " + e.message.substring(0, 30), "ai");
        } finally {
            typing.style.display = "none";
        }
    }

    function addMessage(text, sender) {
        const div = document.createElement('div');
        div.className = `message ${sender === 'user' ? 'user-msg' : 'ai-msg'}`;
        div.innerText = text;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    document.getElementById('send-btn').addEventListener('click', sendMessage);
    input.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });

    onChildAdded(messagesRef, (snapshot) => {
        const data = snapshot.val();
        addMessage(data.text, data.sender);
    });

    onValue(messagesRef, (snapshot) => {
        if (!snapshot.exists()) container.innerHTML = "";
    });

    // Фоновые символы
    const bg = document.getElementById('bg-glass');
    setInterval(() => {
        const span = document.createElement('span');
        span.innerText = "01$#"[Math.floor(Math.random()*4)];
        span.style.position = 'absolute';
        span.style.left = Math.random()*100+'%';
        span.style.top = Math.random()*100+'%';
        bg.appendChild(span);
        setTimeout(() => span.remove(), 1500);
    }, 150);
</script>
