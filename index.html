<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, remove, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDpPOgY_Jc8QjUq7MSa4rPH26YPXS716VI",
        authDomain: "hk-ai-bf133.firebaseapp.com",
        projectId: "hk-ai-bf133",
        databaseURL: "https://hk-ai-bf133-default-rtdb.europe-west1.firebasedatabase.app/",
        appId: "1:1009853924666:web:fa4e356cf060d747f8bc03"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const messagesRef = ref(db, 'chat_messages');

    // Твой ключ из скрина
    const API_KEY = "AIzaSyDQfDlE0SlKK8iDXWz_nr-nTF7IC6LeilM";
    
    const container = document.getElementById('chat-container');
    const input = document.getElementById('user-input');
    const typing = document.getElementById('typing');
    let isConfirming = false;

    async function callGemini(text) {
        // Используем альтернативный эндпоинт, если прямой блокируется
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
        
        const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: [{ parts: [{ text: `ТЫ — HK AI. СТИЛЬ: БРУТАЛЬНЫЙ, КАПСОМ. ОТВЕТЬ НА: ${text}` }] }]
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error.message || "ОШИБКА API");
        }

        const data = await response.json();
        return data.candidates[0].content.parts[0].text.toUpperCase();
    }

    async function handleSend() {
        const val = input.value.trim();
        if (!val) return;

        if (val.toLowerCase() === "очисти чат") {
            addMsg("ВЫ ТОЧНО ХОТИТЕ УДАЛИТЬ ИСТОРИЮ?", "ai");
            isConfirming = true;
            input.value = "";
            return;
        }

        if (isConfirming) {
            if (val.toLowerCase() === "да") {
                await remove(messagesRef);
                container.innerHTML = "";
                addMsg("ИСТОРИЯ ОЧИЩЕНА.", "ai");
            } else {
                addMsg("ОТМЕНЕНО.", "ai");
            }
            isConfirming = false;
            input.value = "";
            return;
        }

        await push(messagesRef, { text: val, sender: "user" });
        input.value = "";
        typing.style.display = "block";

        try {
            const aiRes = await callGemini(val);
            await push(messagesRef, { text: aiRes, sender: "ai" });
        } catch (e) {
            console.error(e);
            addMsg("ОШИБКА: " + e.message.toUpperCase(), "ai");
        } finally {
            typing.style.display = "none";
        }
    }

    function addMsg(text, sender) {
        const d = document.createElement('div');
        d.className = `message ${sender === 'user' ? 'user-msg' : 'ai-msg'}`;
        d.innerText = text;
        container.appendChild(d);
        container.scrollTop = container.scrollHeight;
    }

    document.getElementById('send-btn').onclick = handleSend;
    input.onkeydown = (e) => { if(e.key === 'Enter') handleSend(); };

    onChildAdded(messagesRef, (snap) => {
        const data = snap.val();
        addMsg(data.text, data.sender);
    });
        </script>
