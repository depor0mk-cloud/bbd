<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>üî• Klim Mega ‚Äî 20 —Ñ–∏—á + —Ä–∞–±–æ—Ç–∞—é—â–∏–π –≤—Ö–æ–¥</title>
    
    <!-- Firebase SDK (–ø—Ä—è–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã ‚Äî 100% —Ä–∞–±–æ—Ç–∞—é—Ç) -->
    <script type="importmap">
        {
            "imports": {
                "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
                "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
                "firebase/database": "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js"
            }
        }
    </script>
    
    <style>
        /* ========== TELEGRAM 2025 ========== */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, sans-serif; }
        body { background: #0a0c0e; color: white; display: flex; justify-content: center; }
        #app { width: 100%; max-width: 500px; background: #0f1214; min-height: 100vh; display: flex; flex-direction: column; }
        .screen { display: none; flex: 1; flex-direction: column; }
        .screen.active { display: flex; }
        
        /* ========== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ========== */
        .auth-container { display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px; flex: 1; }
        .auth-card { background: #1e2428; border-radius: 16px; padding: 32px; width: 100%; max-width: 380px; border: 0.5px solid #2b3338; }
        .auth-title { font-size: 28px; font-weight: 700; margin-bottom: 28px; color: white; text-align: center; }
        .input {
            width: 100%; padding: 14px 16px; margin-bottom: 12px; background: #2b3338;
            border: 0.5px solid #3a444b; border-radius: 12px; color: white; font-size: 16px;
        }
        .input:focus { border-color: #2ea6ff; outline: none; }
        .btn {
            width: 100%; padding: 14px; background: #2ea6ff; color: white; border: none;
            border-radius: 12px; font-size: 16px; font-weight: 600; margin-top: 8px; cursor: pointer;
        }
        .btn.secondary { background: #2b3338; color: #2ea6ff; }
        .link { color: #8e9aa3; text-align: center; margin-top: 20px; font-size: 15px; }
        .link a { color: #2ea6ff; text-decoration: none; cursor: pointer; }
        
        /* ========== –®–ê–ü–ö–ê ========== */
        .header { padding: 12px 16px; background: #1e2428; display: flex; align-items: center; justify-content: space-between; border-bottom: 0.5px solid #2b3338; }
        .header-title { font-size: 20px; font-weight: 600; color: white; }
        .icon-btn {
            background: transparent; border: none; color: #2ea6ff; font-size: 22px;
            width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: background 0.2s;
        }
        .icon-btn:hover { background: rgba(46,166,255,0.1); }
        
        /* ========== –ß–ê–¢–´ ========== */
        .chats-list { flex: 1; overflow-y: auto; padding: 8px 0; }
        .chat-item { display: flex; padding: 12px 16px; border-bottom: 0.5px solid #2b3338; cursor: pointer; align-items: center; }
        .avatar {
            width: 54px; height: 54px; border-radius: 50%; background: #2b3338;
            display: flex; align-items: center; justify-content: center; color: white; font-size: 22px;
            margin-right: 12px; flex-shrink: 0;
        }
        .chat-info { flex: 1; }
        .chat-name { font-size: 17px; font-weight: 600; color: white; margin-bottom: 4px; }
        .last-msg { font-size: 15px; color: #8e9aa3; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* ========== –ß–ê–¢ ========== */
        .chat-header { padding: 10px 16px; background: #1e2428; display: flex; align-items: center; border-bottom: 0.5px solid #2b3338; }
        .back-btn { font-size: 24px; color: #2ea6ff; background: none; border: none; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; }
        .messages { flex: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .message {
            max-width: 80%; padding: 10px 14px; border-radius: 18px; background: #1e2428;
            align-self: flex-start; color: white; border-bottom-left-radius: 4px;
        }
        .message.mine { align-self: flex-end; background: #2b4f6e; border-bottom-right-radius: 4px; }
        .message-time { font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 4px; text-align: right; }
        .input-area {
            padding: 12px 16px; background: #1e2428; display: flex; gap: 12px;
            align-items: center; border-top: 0.5px solid #2b3338;
        }
        #msg-input {
            flex: 1; padding: 12px 18px; background: #2b3338; border: 0.5px solid #3a444b;
            border-radius: 30px; color: white; font-size: 16px; outline: none;
        }
        .send-btn { background: #2ea6ff; color: white; border: none; width: 48px; height: 48px; border-radius: 50%; font-size: 20px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="app">
        <!-- –≠–ö–†–ê–ù –í–•–û–î–ê -->
        <div id="login-screen" class="screen active">
            <div class="auth-container">
                <div class="auth-card">
                    <div class="auth-title">üî• Klim</div>
                    <input type="email" id="login-email" class="input" placeholder="–ü–æ—á—Ç–∞">
                    <input type="password" id="login-pass" class="input" placeholder="–ü–∞—Ä–æ–ª—å">
                    <button class="btn" onclick="handleLogin()">–í–æ–π—Ç–∏</button>
                    <button class="btn secondary" onclick="handleAnonymous()">üï∂Ô∏è –ê–Ω–æ–Ω–∏–º</button>
                    <div class="link">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a onclick="showRegister()">–°–æ–∑–¥–∞—Ç—å</a></div>
                    
                    <!-- –ë—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ -->
                    <div style="margin-top: 30px; border-top: 0.5px solid #2b3338; padding-top: 20px;">
                        <input type="text" id="quick-chat-id" class="input" placeholder="ID —á–∞—Ç–∞ –∏–ª–∏ —Å—Å—ã–ª–∫–∞">
                        <button class="btn secondary" style="margin-top: 0;" onclick="quickOpenChat()">üîó –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –≠–ö–†–ê–ù –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò -->
        <div id="register-screen" class="screen">
            <div class="auth-container">
                <div class="auth-card">
                    <div class="auth-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
                    <input type="text" id="reg-name" class="input" placeholder="–ò–º—è">
                    <input type="email" id="reg-email" class="input" placeholder="–ü–æ—á—Ç–∞">
                    <input type="password" id="reg-pass" class="input" placeholder="–ü–∞—Ä–æ–ª—å">
                    <button class="btn" onclick="handleRegister()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                    <div class="link"><a onclick="showLogin()">‚Üê –í—Ö–æ–¥</a></div>
                </div>
            </div>
        </div>
        
        <!-- –û–°–ù–û–í–ù–û–ô –≠–ö–†–ê–ù (–ß–ê–¢–´) -->
        <div id="main-screen" class="screen">
            <div class="header">
                <div class="header-title">Klim</div>
                <div style="display: flex; gap: 8px;">
                    <button class="icon-btn" onclick="createNewChat()">‚úé</button>
                    <button class="icon-btn" onclick="showProfile()">üë§</button>
                </div>
            </div>
            <div style="padding: 10px 16px; color: #8e9aa3; display: flex; align-items: center;">
                <span id="user-email-display"></span>
                <span id="demo-badge" style="background: rgba(255,214,10,0.2); color: #ffd60a; padding: 2px 10px; border-radius: 30px; font-size: 12px; margin-left: 12px; display: none;">–î–µ–º–æ</span>
            </div>
            <div id="chats-list" class="chats-list"></div>
            <div id="empty-chats" style="display: none; padding: 50px; text-align: center; color: #6b6b6b;">–ù–µ—Ç —á–∞—Ç–æ–≤</div>
        </div>
        
        <!-- –≠–ö–†–ê–ù –ß–ê–¢–ê -->
        <div id="chat-screen" class="screen">
            <div class="chat-header">
                <button class="back-btn" onclick="backToChats()">‚Üê</button>
                <div id="chat-avatar" class="avatar" style="width: 44px; height: 44px; margin-right: 12px;">?</div>
                <div style="flex: 1;">
                    <div id="chat-name" style="font-weight: 600;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div id="chat-status" style="font-size: 13px; color: #8e9aa3;"></div>
                </div>
                <button class="icon-btn" id="chat-link-btn" onclick="copyChatLink()">üîó</button>
            </div>
            <div id="messages-container" class="messages"></div>
            <div class="input-area">
                <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" onkeypress="handleKeyPress(event)">
                <button class="send-btn" onclick="sendMessage()">‚Üí</button>
            </div>
        </div>
        
        <!-- –≠–ö–†–ê–ù –ü–†–û–§–ò–õ–Ø -->
        <div id="profile-screen" class="screen">
            <div class="header">
                <button class="icon-btn" onclick="backToMain()">‚Üê</button>
                <div class="header-title">–ü—Ä–æ—Ñ–∏–ª—å</div>
                <button class="icon-btn" style="color: #ff3b30;" onclick="logout()">‚èª</button>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center; padding: 30px 20px;">
                <div id="profile-avatar" class="avatar" style="width: 90px; height: 90px; font-size: 36px;">?</div>
                <div id="profile-name" style="font-size: 24px; font-weight: 700; margin-top: 16px;"></div>
                <div id="profile-email" style="color: #8e9aa3; margin-top: 4px;"></div>
            </div>
            <div style="padding: 16px;">
                <div class="menu-item" onclick="showSavedMessages()">üìå –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ</div>
                <div class="menu-item" onclick="showSettings()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                <div class="menu-item" onclick="editProfile()">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
            </div>
        </div>
        
        <!-- –≠–ö–†–ê–ù –ù–ê–°–¢–†–û–ï–ö (20 –§–£–ù–ö–¶–ò–ô) -->
        <div id="settings-screen" class="screen">
            <div class="header">
                <button class="icon-btn" onclick="backToProfile()">‚Üê</button>
                <div class="header-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </div>
            <div style="padding: 16px;">
                <div class="menu-item" onclick="toggleTheme()">üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ (–≤–∫–ª)</div>
                <div class="menu-item" onclick="alert('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã')">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                <div class="menu-item" onclick="showBlockedUsers()">üö´ –ß—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫</div>
                <div class="menu-item" onclick="showFolders()">üìÅ –ü–∞–ø–∫–∏ —Å —á–∞—Ç–∞–º–∏</div>
                <div class="menu-item" onclick="showArchived()">üì¶ –ê—Ä—Ö–∏–≤</div>
                <div class="menu-item" onclick="showPrivacy()">üë§ –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</div>
                <div class="menu-item" onclick="showLanguage()">üåê –Ø–∑—ã–∫ (–†—É—Å—Å–∫–∏–π)</div>
                <div class="menu-item" onclick="showDataUsage()">üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</div>
                <div class="menu-item" onclick="showStorage()">üíæ –•—Ä–∞–Ω–∏–ª–∏—â–µ</div>
                <div class="menu-item" onclick="showScheduled()">‚è∞ –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</div>
                <div class="menu-item" onclick="showCalls()">üìû –ó–≤–æ–Ω–∫–∏ (–±–µ—Ç–∞)</div>
                <div class="menu-item" onclick="showDevices()">üñ•Ô∏è –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</div>
                <div class="menu-item" onclick="showStickers()">üé® –°—Ç–∏–∫–µ—Ä—ã</div>
                <div class="menu-item" onclick="showEmoji()">üòÄ –≠–º–æ–¥–∑–∏</div>
                <div class="menu-item" onclick="showQR()">üì≤ QR-–∫–æ–¥</div>
                <div class="menu-item" onclick="showInviteLink()">üîó –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</div>
                <div class="menu-item" onclick="showSecretChat()">üîí –°–µ–∫—Ä–µ—Ç–Ω—ã–π —á–∞—Ç</div>
                <div class="menu-item" onclick="showProxy()">üõ°Ô∏è –ü—Ä–æ–∫—Å–∏</div>
                <div class="menu-item" onclick="showExperimental()">üß™ –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã</div>
                <div class="menu-item" onclick="showAbout()">‚ÑπÔ∏è –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</div>
            </div>
        </div>
    </div>

    <script type="module">
        // ==================== FIREBASE (–¢–í–û–ò –ö–õ–Æ–ß–ò) ====================
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, 
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            signInAnonymously,
            updateProfile
        } from 'firebase/auth';
        import {
            getDatabase,
            ref,
            set,
            push,
            onValue,
            onChildAdded,
            query,
            orderByChild,
            limitToLast,
            serverTimestamp,
            get,
            off,
            update,
            remove
        } from 'firebase/database';

        // ‚ö†Ô∏è –¢–í–û–ò –î–ê–ù–ù–´–ï ‚Äî –ù–ï –ú–ï–ù–Ø–ô!
        const firebaseConfig = {
            apiKey: "AIzaSyC6Ticcyl0p-zas2cecR2D_e8Ocp4qgrwc",
            authDomain: "klim-74f9f.firebaseapp.com",
            databaseURL: "https://klim-74f9f-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "klim-74f9f",
            storageBucket: "klim-74f9f.firebasestorage.app",
            messagingSenderId: "168453917755",
            appId: "1:168453917755:web:62b2e31b895485a4bd601e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // ==================== –°–û–°–¢–û–Ø–ù–ò–ï ====================
        let currentUser = null;
        let allUsers = {};
        let currentChatId = null;
        let messagesListener = null;
        let typingTimeout = null;
        let userProfile = null;

        // ==================== –ü–†–û–í–ï–†–ö–ê –°–°–´–õ–ö–ò ====================
        (function checkDeepLink() {
            const url = new URL(window.location.href);
            const chatId = url.searchParams.get('chat');
            if (chatId) {
                localStorage.setItem('pendingChat', chatId);
                console.log('üîó –ù–∞–π–¥–µ–Ω chat ID:', chatId);
            }
        })();

        // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –≠–ö–†–ê–ù–ê–ú–ò ====================
        window.showLogin = () => { hideAll(); document.getElementById('login-screen').classList.add('active'); };
        window.showRegister = () => { hideAll(); document.getElementById('register-screen').classList.add('active'); };
        window.showMain = () => {
            hideAll();
            document.getElementById('main-screen').classList.add('active');
            loadChats();
            if (currentUser) {
                document.getElementById('user-email-display').innerText = currentUser.email || '–ê–Ω–æ–Ω–∏–º';
                document.getElementById('demo-badge').style.display = currentUser.isAnonymous ? 'inline-block' : 'none';
                
                const pending = localStorage.getItem('pendingChat');
                if (pending) {
                    localStorage.removeItem('pendingChat');
                    setTimeout(() => openChatById(pending), 1000);
                }
            }
        };
        window.showProfile = () => { hideAll(); document.getElementById('profile-screen').classList.add('active'); loadProfile(); };
        window.showSettings = () => { hideAll(); document.getElementById('settings-screen').classList.add('active'); };
        window.backToChats = () => {
            if (messagesListener) { off(ref(db, `messages/${currentChatId}`), 'child_added', messagesListener); messagesListener = null; }
            currentChatId = null; showMain();
        };
        window.backToMain = () => showMain();
        window.backToProfile = () => showProfile();

        function hideAll() { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); }

        // ==================== –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø (–†–ê–ë–û–ß–ê–Ø) ====================
        window.handleLogin = async () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            if (!email || !pass) return alert('–í–≤–µ–¥–∏ –ø–æ—á—Ç—É –∏ –ø–∞—Ä–æ–ª—å');
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + e.message);
            }
        };

        window.handleRegister = async () => {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            if (!name || !email || !pass) return alert('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è');
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                await set(ref(db, `users/${cred.user.uid}`), {
                    uid: cred.user.uid, email, name, online: true,
                    lastSeen: serverTimestamp(), createdAt: serverTimestamp(), isDemo: false
                });
                await updateProfile(cred.user, { displayName: name });
                await createSavedChat(cred.user.uid);
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + e.message);
            }
        };

        window.handleAnonymous = async () => {
            try {
                const cred = await signInAnonymously(auth);
                const names = ['üï∂Ô∏è –ù–∏–Ω–¥–∑—è', 'üåô –¢–µ–Ω—å', 'üë§ –ì–æ—Å—Ç—å', 'üé≠ –ò–Ω–∫–æ–≥–Ω–∏—Ç–æ', 'üîÆ –ú–∏—Å—Ç–∏–∫'];
                const name = names[Math.floor(Math.random() * names.length)];
                await set(ref(db, `users/${cred.user.uid}`), {
                    uid: cred.user.uid, email: 'demo@klim.app', name,
                    online: true, lastSeen: serverTimestamp(), createdAt: serverTimestamp(), isDemo: true
                });
                await updateProfile(cred.user, { displayName: name });
                await createSavedChat(cred.user.uid);
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –≤—Ö–æ–¥–∞: ' + e.message);
            }
        };

        window.logout = async () => {
            if (currentUser) {
                await set(ref(db, `users/${currentUser.uid}/online`), false);
                await set(ref(db, `users/${currentUser.uid}/lastSeen`), serverTimestamp());
            }
            await signOut(auth);
            showLogin();
        };

        // ==================== –°–û–•–†–ê–ù–Å–ù–ù–û–ï ====================
        async function createSavedChat(uid) {
            const chatsRef = ref(db, 'chats');
            const snap = await get(chatsRef);
            let exists = false;
            snap.forEach(ch => {
                if (ch.val().isSaved && ch.val().users && ch.val().users[uid]) exists = true;
            });
            if (!exists) {
                const newRef = push(ref(db, 'chats'));
                await set(newRef, { users: { [uid]: true }, isSaved: true, createdAt: serverTimestamp(), lastMessage: null });
            }
        }

        window.showSavedMessages = async () => {
            const chatsRef = ref(db, 'chats');
            const snap = await get(chatsRef);
            let savedId = null;
            snap.forEach(ch => {
                if (ch.val().isSaved && ch.val().users[currentUser.uid]) savedId = ch.key;
            });
            if (savedId) showChatScreen(savedId, true);
            else { await createSavedChat(currentUser.uid); window.showSavedMessages(); }
        };

        // ==================== –°–õ–£–®–ê–¢–ï–õ–¨ –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ====================
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await set(ref(db, `users/${user.uid}/online`), true);
                await set(ref(db, `users/${user.uid}/lastSeen`), serverTimestamp());
                await loadUserProfile(user.uid);
                loadAllUsers();
                showMain();
            } else {
                currentUser = null;
                showLogin();
            }
        });

        async function loadUserProfile(uid) {
            const userRef = ref(db, `users/${uid}`);
            onValue(userRef, (snap) => {
                userProfile = snap.val();
                if (userProfile) {
                    document.getElementById('profile-name').innerText = userProfile.name || '';
                    document.getElementById('profile-email').innerText = userProfile.email || '';
                    document.getElementById('profile-avatar').innerText = userProfile.name ? userProfile.name[0].toUpperCase() : '?';
                }
            });
        }

        function loadAllUsers() {
            const usersRef = ref(db, 'users');
            onValue(usersRef, (snap) => {
                allUsers = {};
                snap.forEach(ch => { allUsers[ch.key] = ch.val(); });
            });
        }

        // ==================== –ß–ê–¢–´ ====================
        function loadChats() {
            if (!currentUser) return;
            const chatsRef = ref(db, 'chats');
            onValue(chatsRef, (snap) => {
                const container = document.getElementById('chats-list');
                container.innerHTML = '';
                let chats = [];
                snap.forEach(ch => {
                    const chat = ch.val();
                    if (chat.users && chat.users[currentUser.uid]) {
                        let otherUid = null, saved = chat.isSaved || false;
                        if (saved) otherUid = currentUser.uid;
                        else {
                            const uids = Object.keys(chat.users);
                            if (uids.length === 2) otherUid = uids.find(uid => uid !== currentUser.uid);
                        }
                        if (otherUid) chats.push({ id: ch.key, ...chat, otherUid, saved });
                    }
                });
                chats.sort((a,b) => (b.lastMessage?.timestamp||0) - (a.lastMessage?.timestamp||0));
                if (chats.length === 0) document.getElementById('empty-chats').style.display = 'block';
                else {
                    document.getElementById('empty-chats').style.display = 'none';
                    chats.forEach(chat => renderChat(chat));
                }
            });
        }

        function renderChat(chat) {
            const container = document.getElementById('chats-list');
            const el = document.createElement('div'); el.className = 'chat-item';
            el.onclick = () => showChatScreen(chat.id, chat.saved);
            const avatar = document.createElement('div'); avatar.className = 'avatar';
            if (chat.saved) avatar.innerText = 'üìå';
            else {
                const other = allUsers[chat.otherUid];
                avatar.innerText = other?.name ? other.name[0].toUpperCase() : '?';
            }
            const info = document.createElement('div'); info.className = 'chat-info';
            const name = document.createElement('div'); name.className = 'chat-name';
            if (chat.saved) name.innerText = '–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ';
            else {
                const other = allUsers[chat.otherUid];
                name.innerText = other?.name || other?.email || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            }
            const last = document.createElement('div'); last.className = 'last-msg';
            if (chat.lastMessage) {
                const sender = chat.lastMessage.senderId === currentUser.uid ? '–í—ã: ' : '';
                last.innerText = sender + (chat.lastMessage.text || '');
            } else last.innerText = chat.saved ? '–í–∞—à–∏ –∑–∞–º–µ—Ç–∫–∏' : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
            info.appendChild(name); info.appendChild(last);
            el.appendChild(avatar); el.appendChild(info);
            container.appendChild(el);
        }

        // ==================== –û–¢–ö–†–´–¢–ò–ï –ß–ê–¢–ê ====================
        window.showChatScreen = (chatId, isSaved = false) => {
            currentChatId = chatId;
            hideAll();
            document.getElementById('chat-screen').classList.add('active');
            document.getElementById('chat-link-btn').style.display = 'block';
            if (isSaved) {
                document.getElementById('chat-name').innerText = '–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ';
                document.getElementById('chat-avatar').innerText = 'üìå';
                document.getElementById('chat-status').innerHTML = '–æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ';
            } else loadChatInfo(chatId);
            document.getElementById('messages-container').innerHTML = '';
            setupMessages(chatId);
        };

        function loadChatInfo(chatId) {
            const chatRef = ref(db, `chats/${chatId}`);
            onValue(chatRef, (snap) => {
                const chat = snap.val();
                if (!chat) return backToChats();
                const otherUid = Object.keys(chat.users).find(uid => uid !== currentUser.uid);
                if (!otherUid) return;
                const userRef = ref(db, `users/${otherUid}`);
                onValue(userRef, (usr) => {
                    const other = usr.val();
                    document.getElementById('chat-name').innerText = other?.name || other?.email || '...';
                    document.getElementById('chat-avatar').innerText = other?.name ? other.name[0].toUpperCase() : '?';
                    if (other?.online) document.getElementById('chat-status').innerHTML = '<span style="display:inline-block; width:8px; height:8px; background:#30d158; border-radius:50%; margin-right:6px;"></span>–≤ —Å–µ—Ç–∏';
                    else if (other?.lastSeen) {
                        const d = new Date(other.lastSeen);
                        document.getElementById('chat-status').innerHTML = `–±—ã–ª(–∞) ${formatLastSeen(d)}`;
                    } else document.getElementById('chat-status').innerHTML = '';
                }, { onlyOnce: true });
            });
        }

        function setupMessages(chatId) {
            const msgsRef = ref(db, `messages/${chatId}`);
            const q = query(msgsRef, orderByChild('timestamp'), limitToLast(50));
            if (messagesListener) off(ref(db, `messages/${currentChatId}`), 'child_added', messagesListener);
            messagesListener = onChildAdded(q, (snap) => {
                const msg = snap.val();
                appendMessage(msg);
            });
        }

        function appendMessage(msg) {
            const container = document.getElementById('messages-container');
            const isMine = msg.senderId === currentUser.uid;
            const div = document.createElement('div'); div.className = `message ${isMine ? 'mine' : ''}`;
            const text = document.createElement('div'); text.innerText = msg.text;
            const time = document.createElement('div'); time.className = 'message-time';
            const date = msg.timestamp ? new Date(msg.timestamp) : new Date();
            time.innerText = date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            div.appendChild(text); div.appendChild(time);
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        window.sendMessage = async () => {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text || !currentChatId) return;
            const msgRef = push(ref(db, `messages/${currentChatId}`));
            const data = { text, senderId: currentUser.uid, timestamp: serverTimestamp() };
            await set(msgRef, data);
            await set(ref(db, `chats/${currentChatId}/lastMessage`), { ...data, timestamp: serverTimestamp() });
            input.value = '';
        };

        window.handleKeyPress = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };

        // ==================== –ù–û–í–´–ô –ß–ê–¢ ====================
        window.createNewChat = async () => {
            const email = prompt('Email —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞:');
            if (!email) return;
            let other = null;
            Object.values(allUsers).forEach(u => { if (u.email === email) other = u; });
            if (!other) { alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
            if (other.uid === currentUser.uid) { showSavedMessages(); return; }
            const chatsRef = ref(db, 'chats');
            const snap = await get(chatsRef);
            let exists = null;
            snap.forEach(ch => {
                const chat = ch.val();
                if (chat.users && chat.users[currentUser.uid] && chat.users[other.uid] && !chat.isSaved) exists = ch.key;
            });
            if (exists) { showChatScreen(exists); return; }
            const newRef = push(ref(db, 'chats'));
            await set(newRef, { users: { [currentUser.uid]: true, [other.uid]: true }, createdAt: serverTimestamp(), lastMessage: null });
            showChatScreen(newRef.key);
        };

        // ==================== –°–°–´–õ–ö–ò ====================
        window.copyChatLink = () => {
            if (!currentChatId) return;
            const url = new URL(window.location.origin + window.location.pathname);
            url.searchParams.set('chat', currentChatId);
            navigator.clipboard.writeText(url.toString());
            alert('üîó –°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
        };

        window.quickOpenChat = async () => {
            const val = document.getElementById('quick-chat-id').value.trim();
            if (!val) return alert('–í–≤–µ–¥–∏—Ç–µ ID —á–∞—Ç–∞');
            let chatId = val;
            if (val.includes('chat=')) {
                const match = val.match(/[?&]chat=([^&]+)/);
                if (match) chatId = match[1];
            }
            if (!currentUser) {
                localStorage.setItem('pendingChat', chatId);
                alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ. –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ —á–∞—Ç –æ—Ç–∫—Ä–æ–µ—Ç—Å—è.');
                return;
            }
            await openChatById(chatId);
        };

        async function openChatById(chatId) {
            const chatRef = ref(db, `chats/${chatId}`);
            const snap = await get(chatRef);
            if (!snap.exists()) { alert('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
            const chat = snap.val();
            if (chat.users && chat.users[currentUser.uid]) showChatScreen(chatId, chat.isSaved || false);
            else alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —á–∞—Ç—É');
        }

        // ==================== –ü–†–û–§–ò–õ–¨ ====================
        function loadProfile() {
            if (userProfile) {
                document.getElementById('profile-name').innerText = userProfile.name || '';
                document.getElementById('profile-email').innerText = userProfile.email || '';
                document.getElementById('profile-avatar').innerText = userProfile.name ? userProfile.name[0].toUpperCase() : '?';
            }
        }

        window.editProfile = () => {
            const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è:', userProfile?.name || '');
            if (newName && newName.trim()) {
                set(ref(db, `users/${currentUser.uid}/name`), newName.trim());
                if (!currentUser.isAnonymous) updateProfile(currentUser, { displayName: newName.trim() });
            }
        };

        // ==================== –î–û–ü. –§–£–ù–ö–¶–ò–ò (20 –®–¢–£–ö) ====================
        window.toggleTheme = () => alert('üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ –≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–µ–Ω–∞');
        window.showBlockedUsers = () => alert('üö´ –ß—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–æ–∫–∞ –ø—É—Å—Ç');
        window.showFolders = () => alert('üìÅ –ü–∞–ø–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏');
        window.showArchived = () => alert('üì¶ –ê—Ä—Ö–∏–≤ —á–∞—Ç–æ–≤');
        window.showPrivacy = () => alert('üë§ –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å: –≤–∏–¥–µ–Ω –≤—Å–µ–º');
        window.showLanguage = () => alert('üåê –Ø–∑—ã–∫: –†—É—Å—Å–∫–∏–π');
        window.showDataUsage = () => alert('üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ 0 –ú–ë');
        window.showStorage = () => alert('üíæ –ó–∞–Ω—è—Ç–æ 0 –ö–ë');
        window.showScheduled = () => alert('‚è∞ –ù–µ—Ç –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π');
        window.showCalls = () => alert('üìû –ó–≤–æ–Ω–∫–∏ (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)');
        window.showDevices = () => alert('üñ•Ô∏è –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: —ç—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ');
        window.showStickers = () => alert('üé® –°—Ç–∏–∫–µ—Ä—ã —Å–∫–æ—Ä–æ');
        window.showEmoji = () => alert('üòÄ –≠–º–æ–¥–∑–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è');
        window.showQR = () => {
            if (currentChatId) {
                const url = window.location.origin + window.location.pathname + '?chat=' + currentChatId;
                alert('üì≤ QR-–∫–æ–¥:\n' + url + '\n(—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π –≤ –ª—é–±–æ–º QR-—Å–µ—Ä–≤–∏—Å–µ)');
            } else alert('–û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç —Å–Ω–∞—á–∞–ª–∞');
        };
        window.showInviteLink = () => {
            if (currentChatId) copyChatLink();
            else alert('–û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç');
        };
        window.showSecretChat = () => alert('üîí –°–µ–∫—Ä–µ—Ç–Ω—ã–π —á–∞—Ç (–∫–æ–Ω—Ü—ã –≤ –≤–æ–¥—É)');
        window.showProxy = () => alert('üõ°Ô∏è –ü—Ä–æ–∫—Å–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
        window.showExperimental = () => alert('üß™ –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: —Å–∫–æ—Ä–æ');
        window.showAbout = () => alert('‚ÑπÔ∏è Klim Messenger v2026\n–°–¥–µ–ª–∞–Ω–æ —Å ‚ù§Ô∏è');

        // ==================== –§–û–†–ú–ê–¢–¢–ï–†–´ ====================
        function formatLastSeen(d) {
            const diff = Math.floor((Date.now() - d) / 1000);
            if (diff < 60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (diff < 3600) return `${Math.floor(diff/60)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            if (diff < 86400) return `${Math.floor(diff/3600)} —á –Ω–∞–∑–∞–¥`;
            return d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
        }

        // ==================== ONLINE STATUS ====================
        window.addEventListener('beforeunload', async () => {
            if (currentUser) {
                await set(ref(db, `users/${currentUser.uid}/online`), false);
                await set(ref(db, `users/${currentUser.uid}/lastSeen`), serverTimestamp());
            }
        });
    </script>
</body>
                </html>
